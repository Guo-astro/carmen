<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

### Table of Contents

-   [Geocoder](#geocoder)
    -   [Geocoder#geocode](#geocodergeocode)
    -   [Geocoder#index](#geocoderindex)
    -   [Geocoder#merge](#geocodermerge)
    -   [Geocoder#multimerge](#geocodermultimerge)
-   [CarmenSource](#carmensource)
-   [geocode](#geocode)
-   [phrasematch](#phrasematch)
-   [spatialmatch](#spatialmatch)
-   [verifymatch](#verifymatch)
-   [index](#index)
-   [merge](#merge)
    -   [Document Merge](#document-merge)
    -   [RocksDB grid and freq caches](#rocksdb-grid-and-freq-caches)
    -   [DAWG merge](#dawg-merge)
-   [multimerge](#multimerge)

## Geocoder

[index.js:35-319](https://github.com/mapbox/carmen/blob/8549b2f58c071219a033c2295ff1bd14b74314dc/index.js#L35-L319 "Source code on GitHub")

Geocoder is an interface used to submit a single query to
multiple indexes, returning a single set of ranked results.

**Parameters**

-   `indexes` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)&lt;[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String), [CarmenSource](#carmensource)>** A one-to-one mapping from index layer name to a [CarmenSource](#carmensource).
-   `options` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** options
    -   `options.tokens` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)&lt;[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String), [string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)>** mapping from string patterns to strings. patterns are replaced with strings when found in queries. this is treated as a global token replacement map: any substring matching a pattern key (which can be regex) is replaced with the associated string value.
    -   `options.geocoder_inverse_tokens` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)&lt;[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String), ([string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String) \| [Function](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/function))>** for reversing abbreviations. Replace key with a stipulated string value or pass it to a function that returns a string. see [text-processsing](./text-processing.md) for details.

### Geocoder#geocode

[index.js:425-431](https://github.com/mapbox/carmen/blob/8549b2f58c071219a033c2295ff1bd14b74314dc/index.js#L425-L431 "Source code on GitHub")

-   **See: [gecode](#geocode) for more details, including
    `options` properties.**

Main entry point for geocoding API. Returns results across all indexes for
a given query.

**Parameters**

-   `query` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** a query string, eg "Chester, NJ"
-   `options` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** options
-   `callback` **[function](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/function)** a callback function, passed on to [geocode](#geocode)

### Geocoder#index

[index.js:450-456](https://github.com/mapbox/carmen/blob/8549b2f58c071219a033c2295ff1bd14b74314dc/index.js#L450-L456 "Source code on GitHub")

-   **See: [index](#index) for more details, including `options` properties.**

Main entry point for indexing. Index a stream of GeoJSON docs.

**Parameters**

-   `from` **[stream.Readable](https://nodejs.org/api/stream.html#stream_class_stream_readable)** a readable stream of GeoJSON features
-   `to` **[CarmenSource](#carmensource)** the interface to the index's destination
-   `options` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** options
    -   `options.zoom` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** the max zoom level for the index
    -   `options.output` **[stream.Writable](https://nodejs.org/api/stream.html#stream_class_stream_writable)** the output stream for
    -   `options.tokens` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)&lt;[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String), [string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)>** mapping from string patterns to strings. patterns are replaced with strings when found in queries. helpful for abbreviations, eg. "Streets" => "St"
-   `callback` **[function](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/function)** a callback function, passed on to [inde](#index)

### Geocoder#merge

[index.js:473-479](https://github.com/mapbox/carmen/blob/8549b2f58c071219a033c2295ff1bd14b74314dc/index.js#L473-L479 "Source code on GitHub")

-   **See: [merge](#merge) for more details, including `options` properties.**

Merge two CarmenSources and output to a third.

**Parameters**

-   `geocoder` **[Geocoder](#geocoder)** an instance of carmen Geocoder
-   `from1` **[CarmenSource](#carmensource)** a source index to be merged
-   `from2` **[CarmenSource](#carmensource)** another source to be merged
-   `to` **[CarmenSource](#carmensource)** the destination of the merged sources
-   `options` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** options
-   `callback` **[function](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/function)** a callback function

### Geocoder#multimerge

[index.js:494-500](https://github.com/mapbox/carmen/blob/8549b2f58c071219a033c2295ff1bd14b74314dc/index.js#L494-L500 "Source code on GitHub")

-   **See: [multimerge](#multimerge) for more details, including `options` properties.**

Merge more than two CarmenSources. Only supports MBTile sources.

**Parameters**

-   `fromFiles` **[Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)>** array of paths to input mbtiles files
-   `toFile` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** path to output of merge
-   `options` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** options
-   `callback` **[function](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/function)** a callback function

## CarmenSource

[index.js:350-380](https://github.com/mapbox/carmen/blob/8549b2f58c071219a033c2295ff1bd14b74314dc/index.js#L350-L380 "Source code on GitHub")

An interface to the underlying data that a [Geocoder](#geocoder) instance is indexing and querying. In addition to the properties described below, instances must satisfy interface requirements for `Tilesource` and `Tilesink`. See tilelive [API Docs](https://github.com/mapbox/tilelive/blob/master/API.md) for more info. Currently, carmen supports the following tilelive modules:

-   [tilelive-s3](https://github.com/mapbox/tilelive-s3)
-   [node-mbtiles](https://github.com/mapbox/node-mbtiles)
-   [MemSource](MemSource)

Type: [function](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/function)

**Properties**

-   `getGeocoderData` **function ([index](#index), shard, callback)** get carmen record at `shard` in `index` and call callback with `(err, buffer)`
-   `putGeocoderData` **function ([index](#index), shard, [buffer](https://nodejs.org/api/buffer.html), callback)** put buffer into a shard with index `index`, and call callback with `(err)`
-   `geocoderDataIterator` **function (type)** TODO
-   `getIndexableDocs` **function (pointer, callback)** get documents needed to create a forward geocoding datasource. `pointer` is an optional object that has different behavior depending on the implementation. It is used to indicate the state of the database, similar to a cursor, and can allow pagination, limiting, etc. `callback` is called with `(error, documents, pointer)` in which `documents` is a list of objects.

## geocode

[lib/geocode.js:40-159](https://github.com/mapbox/carmen/blob/8549b2f58c071219a033c2295ff1bd14b74314dc/lib/geocode.js#L40-L159 "Source code on GitHub")

Main interface for querying an index and returning ranked results.

**Parameters**

-   `geocoder` **[Geocoder](#geocoder)** the geocoder itself
-   `query` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** a query string. If the query appears to be a longitude, latitude pair (eg "-75.1327,40.0115"), it is assumed to be a reverse query.
-   `options` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** options
    -   `options.proximity` **[Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)>?** a `[ lon, lat ]` array to use for biasing search results. Features closer to the proximity value will be given priority over those further from the proximity value.
    -   `options.types` **[Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)>?** an array of string types. Only features matching one of the types specified will be returned.
    -   `options.language` **[Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)>?** One or more [ISO 639-1 codes](https://en.wikipedia.org/wiki/List_of_ISO_639-1_codes), separated by commas to be displayed. Only the first language code is used when prioritizing forward geocode results to be matched. If `carmen:text_{lc}` and/or `geocoder_format_{lc}` are available on a features, response will be returned in that language and appropriately formatted.
    -   `options.languageMode` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)?** string. If set to `"strict"` the returned features will be filtered to only those with text matching the language specified by the
    -   `options.bbox` **[Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)>?** a `[ w, s, e, n ]` bbox array to use for limiting search results. Only features inside the provided bbox will be included.
    -   `options.limit` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** Adjust the maximium number of features returned. (optional, default `5`)
    -   `options.allow_dupes` **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)** If true, carmen will allow features with identical place names to be returned. (optional, default `false`)
    -   `options.debug` **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)** If true, the carmen debug object will be returned as part of the results and internal carmen properties will be preserved on feature output. (optional, default `false`)
    -   `options.stats` **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)** If true, the carmen stats object will be returned as part of the results. (optional, default `false`)
    -   `options.indexes` **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)** If true, indexes will be returned as part of the results. (optional, default `false`)
    -   `options.autocomplete` **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)** If true, indexes will be returned as part of the results. (optional, default `true`)
    -   `options.reverseMode` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** Choices are `'distance'`, `'score'`. Affects the way that a result's context array is built (optional, default `'distance'`)
-   `callback` **[function](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/function)** a callback function

## phrasematch

[lib/phrasematch.js:17-119](https://github.com/mapbox/carmen/blob/8549b2f58c071219a033c2295ff1bd14b74314dc/lib/phrasematch.js#L17-L119 "Source code on GitHub")

phrasematch

**Parameters**

-   `source` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** a Geocoder datasource
-   `query`  
-   `options` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** passed through the geocode function in geocode.js
-   `callback` **[Function](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/function)** called with `(err, phrasematches, source)`
-   `a` **[Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array)** list of terms composing the query to Carmen

## spatialmatch

[lib/spatialmatch.js:27-124](https://github.com/mapbox/carmen/blob/8549b2f58c071219a033c2295ff1bd14b74314dc/lib/spatialmatch.js#L27-L124 "Source code on GitHub")

spatialmatch determines whether indexes can be spatially stacked and discards indexes that cannot be stacked together

**Parameters**

-   `query` **[Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array)** a list of terms composing the query to Carmen
-   `phrasematchResults` **[Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array)** for subquery permutations generated by ./lib/phrasematch
-   `options` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** passed in with the query
-   `callback` **[function](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/function)** callback called with indexes that could be spatially stacked

## verifymatch

[lib/verifymatch.js:30-94](https://github.com/mapbox/carmen/blob/8549b2f58c071219a033c2295ff1bd14b74314dc/lib/verifymatch.js#L30-L94 "Source code on GitHub")

verifymatch - results from spatialmatch are now verified by querying real geometries in vector tiles

**Parameters**

-   `query` **[Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array)** a list of terms composing the query to Carmen
-   `stats` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** ?
-   `geocoder` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** a geocoder datasource
-   `matched` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** resultant indexes that could be spatially stacked
-   `options` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** passed through the geocode function in geocode.js
-   `callback` **[Function](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/function)** callback function which is called with the verified indexes in the correct hierarchical order

## index

[lib/index.js:30-97](https://github.com/mapbox/carmen/blob/8549b2f58c071219a033c2295ff1bd14b74314dc/lib/index.js#L30-L97 "Source code on GitHub")

The main interface for building an index

**Parameters**

-   `geocoder` **[Geocoder](#geocoder)** a [Geocoder](#geocoder) instance
-   `from` **[stream.Readable](https://nodejs.org/api/stream.html#stream_class_stream_readable)** a stream of geojson features
-   `to` **[CarmenSource](#carmensource)** the interface to the index's destinaton
-   `options` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** options
    -   `options.zoom` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** the max zoom level for the index
    -   `options.output` **[stream.Writable](https://nodejs.org/api/stream.html#stream_class_stream_writable)** the output stream for
    -   `options.tokens` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)&lt;[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String), [string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)>** mapping from string patterns to strings. patterns are replaced with strings when found in queries. helpful for abbreviations, eg. "Streets" => "St"
-   `callback` **[function](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/function)** A callback function

## merge

[lib/merge.js:226-448](https://github.com/mapbox/carmen/blob/8549b2f58c071219a033c2295ff1bd14b74314dc/lib/merge.js#L226-L448 "Source code on GitHub")

Merge two CarmenSources. The merge happens in three steps

### Document Merge

The `Feature` documents from each source are joined and merged where
necessary. The join is a [full outer join](https://www.w3schools.com/sql/sql_join_full.asp),
meaning that all elements of the two sources are returned. A stream of
records is returned like:

    { shard: <shard_value>, data1: <from1_document>, data2: <from2_docment> }

The full outer join means:

| if a shard value...              | `data1`     | `data2`     |
| -------------------------------- | ----------- | ----------- |
| ...exists in `from1` and `from2` | `Feature`   | `Feature`   |
| ...only exists in `from1`        | `Feature`   | `undefined` |
| ...only exists in `from2`        | `undefined` | `Feature`   |

### RocksDB grid and freq caches

see [RocksDBCache#merge](RocksDBCache#merge).

### DAWG merge

TODO: document how dawg merge works

**Parameters**

-   `geocoder` **[Geocoder](#geocoder)** an instance of carmen Geocoder
-   `from1` **[CarmenSource](#carmensource)** a source index to be merged
-   `from2` **[CarmenSource](#carmensource)** another source to be merged
-   `to` **[CarmenSource](#carmensource)** the destination of the merged sources
-   `options` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** options
-   `callback` **[function](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/function)** a callback function

## multimerge

[lib/merge.js:495-579](https://github.com/mapbox/carmen/blob/8549b2f58c071219a033c2295ff1bd14b74314dc/lib/merge.js#L495-L579 "Source code on GitHub")

Merge more than two CarmenSources. Only supports MBTile sources.

**Parameters**

-   `fromFiles` **[Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)>** array of paths to input mbtiles files
-   `toFile` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** path to output of merge
-   `options` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** options
-   `callback` **[function](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/function)** a callback function
