<!DOCTYPE html>
<html>
<head>
<meta charset='UTF-8'/>
<title>carmen</title>
<style type='text/css'>
body {
  font:12px/20px Arial,sans-serif;
  }

#map {
  position:absolute;
  left:0px; right:0px; top:0px; bottom:0px;
  }

#input {
  position:absolute;
  left:10px;
  top:10px;
  padding:10px;
  background:rgba(255,255,255,0.9);
  box-shadow:rgba(0,0,0,0.25) 0px 0px 5px;
  }

#input,
.item,
.query {
  border-radius:3px;
  }

.query { padding:5px 10px; }

a { text-decoration:none; color:#444; }

.item {
  margin:5px 0px 0px;
  padding:4px 9px;
  border:1px solid #d0d8dc;
  background:#e0e8ec;
  display:block;
  }

.item span {
  display:block;
  }

</style>

<script src='http://documentcloud.github.com/underscore/underscore-min.js' type='text/javascript'></script>
<script src='http://mapbox.com/easey/ext/modestmaps.min.js' type='text/javascript'></script>
<script src='http://mapbox.com/easey/src/easey.js' type='text/javascript'></script>
<script src='http://mapbox.com/easey/src/easey.handlers.js' type='text/javascript'></script>
<script src='http://mapbox.com/easey/ext/wax.mm.min.js' type='text/javascript'></script>
<script src='http://code.jquery.com/jquery-1.7.1.min.js' type='text/javascript'></script>

<script type='text/javascript'>
window.onload = function() {

_.templateSettings = {
  interpolate: /\{\{(.+?)\}\}/g
};

var mm = com.modestmaps;
var tilejson = {
    center: [ 0, 0, 4 ],
    scheme: "xyz",
    tiles: [
        "http://a.tiles.mapbox.com/v3/mapbox.mapbox-light/{z}/{x}/{y}.png",
        "http://b.tiles.mapbox.com/v3/mapbox.mapbox-light/{z}/{x}/{y}.png",
        "http://c.tiles.mapbox.com/v3/mapbox.mapbox-light/{z}/{x}/{y}.png",
        "http://d.tiles.mapbox.com/v3/mapbox.mapbox-light/{z}/{x}/{y}.png"
    ]
};
map = new com.modestmaps.Map('map',
    new wax.mm.connector(tilejson), null, [
        new easey.DragHandler(),
        new easey.TouchHandler(),
        new easey.DoubleClickHandler(),
        new easey.MouseWheelHandler()
    ]);
map.setCenterZoom(new com.modestmaps.Location(
    tilejson.center[1],
    tilejson.center[0]),
    tilejson.center[2]);

var getZ = function(type) {
    if (type === 'city') return 12;
    if (type === 'province') return 8;
    return 6;
};

$('#input').delegate('a.item', 'click', function(ev) {
    var lonlat = $(ev.currentTarget).attr('href').split('#').pop().split(',');
    map.setCenterZoom(new com.modestmaps.Location(
        lonlat[1],
        lonlat[0]),
        lonlat[2]);
    return false;
});
$('#input').submit(function(ev) {
    var q = $('#query').val();
    $.ajax({ url: '/api/' + q, success: function(resp) {
        if (!resp.results.length) {
            $('.results').html(
                "<div class='query'>" + resp.query.join(',') + "</div>" +
                "<a class='item'>No matches.</a>"
            );
            return;
        }
        $('.results').html(
            "<div class='query'>" + resp.query.join(',') + "</div>" +
            _(resp.results).chain()
                .map(function(result) {
                    var item = _("<a class='item' href='#{{lonlat}}'>{{terms}}</a>").template();
                    var term = _("<span>{{name}} ({{type}})</span>").template();
                    return item({
                        lonlat: result.lon + ',' + result.lat + ',' + getZ(result.type),
                        terms: term(result)
                    });
                })
                .value()
                .join('\n')
        );
        map.setCenterZoom(new com.modestmaps.Location(
            resp.results[0].lat,
            resp.results[0].lon),
            getZ(resp.results[0].type));
    }});
    return false;
});

};
</script>
</head>
<body>
  <div id='map'></div>
  <form id='input'>
    <input id='query' type='text' />
    <input type='submit' value='Go' />
    <div class='results'></div>
  </form>
</body>
</html>
